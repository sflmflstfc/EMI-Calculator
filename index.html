<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Finance Calculators — Saptagiri / Shree Mahalaxmi</title>

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Styles: professional, clean -->
<style>
  :root{
    --primary:#0b3d91;       /* deep blue */
    --accent:#1e40af;
    --muted:#6b7280;
    --bg:#f4f6fb;
    --card:#ffffff;
    --shadow: 0 6px 18px rgba(15,23,42,0.06);
    --radius:12px;
  }
  html,body{height:100%;margin:0;font-family:Inter, 'Segoe UI', Roboto, system-ui, -apple-system, 'Helvetica Neue', Arial; background:var(--bg); color:#111827;}
  .container{max-width:1100px;margin:28px auto;padding:18px;}
  .brand{
    display:flex;align-items:center;gap:12px;padding:18px;border-radius:12px;background:linear-gradient(90deg,#eef6ff, #ffffff);
    box-shadow: var(--shadow);
  }
  .brand h1{margin:0;font-size:20px;color:var(--primary);letter-spacing:0.2px;}
  .brand p{margin:0;color:var(--muted);font-size:13px;}
  .tabs{display:flex;gap:8px;margin:20px 0;flex-wrap:wrap;}
  .tab{
    background:#fff;padding:10px 14px;border-radius:10px;border:1px solid #e6edf6;cursor:pointer;font-weight:600;color:var(--muted);
    box-shadow:0 2px 6px rgba(15,23,42,0.03);
  }
  .tab.active{background:var(--primary);color:#fff;border-color:transparent;box-shadow: 0 6px 22px rgba(11,61,145,0.12);}
  .tab-content{display:none;background:var(--card);padding:18px;border-radius:var(--radius);box-shadow:var(--shadow);margin-top:8px;}
  .tab-content.active{display:block;}

  /* forms and layout */
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;}
  .grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
  .row{display:flex;gap:12px;align-items:center;margin:8px 0;}
  input[type="number"], input[type="text"], select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf6;background:#fbfdff;text-align:center;font-weight:600;}
  input.yellow, select.yellow { background:#fff8dc; }
  label{font-weight:600;color:var(--muted);font-size:13px;}

  button{
    border:0;border-radius:8px;padding:10px 14px;background:var(--primary);color:white;font-weight:700;cursor:pointer;
    box-shadow:0 6px 18px rgba(11,61,145,0.08);
  }
  button.ghost{background:#fff;color:var(--primary);border:1px solid #dbeafe;font-weight:700;}
  button.small{padding:8px 10px;font-size:13px;}

  h2{color:var(--accent);margin:0 0 12px 0;font-size:18px;}
  .card{background:#fff;border-radius:10px;padding:14px;border:1px solid #eef4ff;box-shadow:0 6px 18px rgba(2,6,23,0.03);}

  /* report layout */
  .report-rupee{font-size:28px;font-weight:800;color:var(--accent);text-align:center;margin-bottom:6px;}
  .report-header{font-size:13px;color:var(--muted);text-align:center;margin-bottom:8px;}
  .disclaimer{font-size:13px;color:#555;text-align:center;margin-top:10px;font-style:italic;}

  .row-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px dashed #f1f6ff;font-size:14px;}
  .row-item strong{color:#111827;}
  .muted{color:var(--muted);}

  /* highlighted big blue style */
  .highlight-big-blue { font-size:18px; font-weight:800; color:var(--primary); }
  .highlight-blue { font-weight:700; color:var(--accent); }

  /* share buttons */
  .share-buttons{text-align:center;margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center;}
  .share-buttons button{background:var(--primary);padding:8px 12px;border-radius:8px;font-weight:700;}
  .export-group{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;align-items:center;}

  table{width:100%;border-collapse:collapse;margin-top:12px;}
  table th, table td{border:1px solid #eef4ff;padding:8px;text-align:center;font-size:13px;}
  table th{background:#f8fbff;color:var(--muted);font-weight:700;}

  /* responsive */
  @media(max-width:900px){
    .grid{grid-template-columns:1fr;}
    .grid-3{grid-template-columns:1fr;}
    .brand{flex-direction:column;align-items:flex-start;}
    .export-group{justify-content:center;}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="brand">
      <div style="flex:1">
        <h1>Saptagiri Finance & Shree Mahalaxmi Finance</h1>
        <p>Quick calculators — Denomination · EMI · Pre-closure · Vehicle · Chit Fund</p>
      </div>
      <div style="text-align:right">
        <div style="font-weight:700;color:var(--muted)">Prepared for office use</div>
        <div style="font-size:12px;color:var(--muted)">Generated locally — no data leaves your browser</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" style="margin-top:18px;">
      <div class="tab active" onclick="openTab('denomination')">Denomination</div>
      <div class="tab" onclick="openTab('preclosure')">Pre-closure</div>
      <div class="tab" onclick="openTab('emi')">EMI Calculator</div>
      <div class="tab" onclick="openTab('vehicleemi')">Vehicle EMI Report</div>
      <div class="tab" onclick="openTab('chit')">Chit Calculator</div>
    </div>

    <!-- Denomination -->
    <div id="denomination" class="tab-content active">
      <h2>Denomination Calculator</h2>
      <div class="grid">
        <div class="card">
          <div class="row"><label>₹500</label><input id="d500" type="number" value="0" /></div>
          <div class="row"><label>₹200</label><input id="d200" type="number" value="0" /></div>
          <div class="row"><label>₹100</label><input id="d100" type="number" value="0" /></div>
          <div class="row"><label>₹50</label><input id="d50" type="number" value="0" /></div>
          <div class="row"><label>₹20</label><input id="d20" type="number" value="0" /></div>
          <div class="row"><label>₹10</label><input id="d10" type="number" value="0" /></div>
          <div class="row"><label>₹5</label><input id="d5" type="number" value="0" /></div>
          <div style="display:flex;justify-content:space-between;margin-top:12px;">
            <div>
              <button onclick="calculateDenomination()">Calculate</button>
            </div>
            <div class="export-group">
              <button class="ghost small" onclick="exportSectionPDF('denominationResult','Denomination_Report.pdf')">Export PDF</button>
              <button class="ghost small" onclick="exportSectionJPG('denominationResult','Denomination_Report.jpg')">Export JPG</button>
            </div>
          </div>
        </div>

        <div id="denominationResult" class="card" style="min-height:180px;">
          <div class="report-header">Result area — click Calculate</div>
        </div>
      </div>

      <div class="share-buttons" style="margin-top:12px;">
        <button onclick="shareReportByText('denominationResult','Denomination Report')">Share WhatsApp</button>
        <button onclick="shareReportByEmail('denominationResult','Denomination Report')">Share Email</button>
        <button onclick="shareReportBySMS('denominationResult','Denomination Report')">Share SMS</button>
      </div>
    </div>

    <!-- Pre-closure -->
    <div id="preclosure" class="tab-content">
      <h2>Loan Pre-closure</h2>
      <div class="grid">
        <div class="card">
          <div class="row"><label>EMI With P & I</label><input id="emiWithInterest" type="number" /></div>
          <div class="row"><label>EMI Without Interest</label><input id="emiWithoutInterest" type="number" /></div>
          <div class="row"><label>No of Future EMI With P & I</label><input id="futureEmiWithInterest" type="number" /></div>
          <div class="row"><label>No of Future EMI Without I</label><input id="futureEmiWithoutInterest" type="number" /></div>
          <div class="row"><label>Current Outstanding</label><input id="currentOutstanding" type="number" /></div>

          <div style="display:flex;justify-content:space-between;margin-top:12px;">
            <div><button onclick="showPreclosureManual()">Show Summary</button></div>
            <div class="export-group">
              <button class="ghost small" onclick="exportSectionPDF('preclosureResult','Preclosure_Report.pdf')">Export PDF</button>
              <button class="ghost small" onclick="exportSectionJPG('preclosureResult','Preclosure_Report.jpg')">Export JPG</button>
              <button class="ghost small" onclick="exportPreclosureExcel()">Export Excel</button>
            </div>
          </div>
        </div>

        <div id="preclosureResult" class="card" style="min-height:180px;">
          <div class="report-header">Summary will appear here</div>
        </div>
      </div>

      <div class="share-buttons" style="margin-top:12px;">
        <button onclick="shareReportByText('preclosureResult','Preclosure Summary')">Share WhatsApp</button>
        <button onclick="shareReportByEmail('preclosureResult','Preclosure Summary')">Share Email</button>
        <button onclick="shareReportBySMS('preclosureResult','Preclosure Summary')">Share SMS</button>
      </div>
    </div>

    <!-- EMI Calculator -->
    <div id="emi" class="tab-content">
      <h2>EMI Calculator</h2>
      <div class="grid">
        <div class="card">
          <div class="row"><label>NEFT / CHQ AMOUNT</label><input id="neft" class="yellow" type="number" value="95500" /></div>
          <div class="row"><label>INTEREST PA (%)</label><input id="rate" class="yellow" type="number" value="11.99" step="0.01" /></div>
          <div class="row"><label>PROCESSING FEES</label><input id="fees" class="yellow" type="number" value="4500" /></div>
          <div class="row"><label>DEALER INCENTIVE / OTHER EXPENSES</label><input id="dealer" class="yellow" type="number" value="1000" /></div>
          <div class="row"><label>LOAN TERM (Months, e.g. 12,18,24,36)</label><input id="terms" class="yellow" type="text" value="12,18,24,36" /></div>
          <div class="row"><label>Interest Type</label>
            <select id="type" class="yellow">
              <option>Flat</option>
              <option selected>Reducing</option>
            </select>
          </div>

          <div style="display:flex;justify-content:space-between;margin-top:12px;">
            <div><button onclick="generateEMIReport()">Generate Report</button></div>
            <div class="export-group">
              <button class="ghost small" onclick="exportSectionPDF('report','EMI_Report.pdf')">Export PDF</button>
              <button class="ghost small" onclick="exportSectionJPG('report','EMI_Report.jpg')">Export JPG</button>
            </div>
          </div>
        </div>

        <div id="report" class="card" style="min-height:220px;">
          <div class="report-header">EMI reports will appear here after Generate</div>
        </div>
      </div>

      <div class="share-buttons" style="margin-top:12px;">
        <button onclick="shareReportByText('report','EMI Report')">Share WhatsApp</button>
        <button onclick="shareReportByEmail('report','EMI Report')">Share Email</button>
        <button onclick="shareReportBySMS('report','EMI Report')">Share SMS</button>
      </div>
    </div>

    <!-- Vehicle EMI -->
    <div id="vehicleemi" class="tab-content">
      <h2>Vehicle EMI Report — PERSONAL LOAN</h2>
      <div class="card">
        <div class="grid">
          <div>
            <div class="row"><label>Vehicle Price</label><input id="vprice" type="number" value="115000"></div>
            <div class="row"><label>Down Payment</label><input id="vdown" type="number" value="34999"></div>
            <div class="row"><label>Dealer Incentive</label><input id="vdealer" type="number" value="1000"></div>
          </div>

          <div>
            <div class="row"><label>Processing Fees</label><input id="vproc" type="number" value="4800"></div>
            <div class="row"><label>ROI % (pa)</label><input id="vroi" type="number" step="0.01" value="11.99"></div>
            <div class="row"><label>Term(s) in months, e.g., 12,24,36</label><input id="vterm" type="text" value="12,18,24,36"></div>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;margin-top:12px;">
          <div>
            <button id="generateVehicleEMI">Generate Report(s)</button>
            <button id="downloadVehiclePdf" class="ghost small">Download PDF</button>
            <button id="downloadVehicleImg" class="ghost small">Download Image</button>
          </div>
          <div class="export-group">
            <div class="muted">Vehicle reports will appear below</div>
          </div>
        </div>
      </div>

      <div id="vehicleReport" class="grid" style="margin-top:12px;"></div>

      <div class="share-buttons" style="margin-top:12px;">
        <button onclick="shareReportByText('vehicleReport','Vehicle EMI Report')">Share WhatsApp</button>
        <button onclick="shareReportByEmail('vehicleReport','Vehicle EMI Report')">Share Email</button>
        <button onclick="shareReportBySMS('vehicleReport','Vehicle EMI Report')">Share SMS</button>
      </div>
    </div>

    <!-- Chit Fund -->
    <div id="chit" class="tab-content">
      <h2>Chit Fund Calculator</h2>
      <div class="grid">
        <div class="card">
          <div class="row"><label>No. of Members</label><input id="members" type="number" value="10"></div>
          <div class="row"><label>Term (months)</label><input id="term" type="number" value="12"></div>
          <div class="row"><label>Monthly Subscription</label><input id="subscription" type="number" value="10000"></div>
          <div class="row"><label>No. of Payable Members per Month</label><input id="payable" type="number" value="10"></div>
          <div class="row"><label>Deduction % (comma-separated for each month)</label><input id="deductions" type="text" value="5,4,3,2,1,1,1,1,1,1,1,1"></div>

          <div style="display:flex;justify-content:space-between;margin-top:12px;">
            <div><button onclick="generateSchedule()">Generate Schedule</button></div>
            <div class="export-group">
              <button class="ghost small" onclick="exportSectionPDF('schedule','ChitFund_Report.pdf')">Export PDF</button>
              <button class="ghost small" onclick="exportChitExcel()">Export Excel</button>
              <button class="ghost small" onclick="exportSectionJPG('schedule','ChitFund_Report.jpg')">Export JPG</button>
            </div>
          </div>
        </div>

        <div id="dealResult" class="card" style="min-height:80px;">
          <div class="report-header">Deal result will appear here</div>
        </div>

        <div id="schedule" class="card" style="grid-column:1 / -1; margin-top:8px;">
          <div class="report-header">Schedule will appear here</div>
        </div>
      </div>

      <div class="share-buttons" style="margin-top:12px;">
        <button onclick="shareReportByText('schedule','Chit Fund Schedule')">Share WhatsApp</button>
        <button onclick="shareReportByEmail('schedule','Chit Fund Schedule')">Share Email</button>
        <button onclick="shareReportBySMS('schedule','Chit Fund Schedule')">Share SMS</button>
      </div>
    </div>

  </div>

<!-- Scripts -->
<script>
/* ---------- Utilities ---------- */
function openTab(id){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  // activate tab header
  const tabEls = document.querySelectorAll('.tab');
  tabEls.forEach(t => { if(t.getAttribute('onclick') && t.getAttribute('onclick').includes("'" + id + "'")) t.classList.add('active'); });
  // activate content
  document.getElementById(id).classList.add('active');
}

function fmt(n){ return "₹"+Number(n).toLocaleString('en-IN'); }
function fmt2(n){ return (isFinite(n)? "₹" + Number(n).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}) : '-') }

/* ---------- Denomination ---------- */
function calculateDenomination(){
  const d500 = Number(document.getElementById('d500').value||0);
  const d200 = Number(document.getElementById('d200').value||0);
  const d100 = Number(document.getElementById('d100').value||0);
  const d50  = Number(document.getElementById('d50').value||0);
  const d20  = Number(document.getElementById('d20').value||0);
  const d10  = Number(document.getElementById('d10').value||0);
  const d5   = Number(document.getElementById('d5').value||0);
  const total = d500*500 + d200*200 + d100*100 + d50*50 + d20*20 + d10*10 + d5*5;

  const html = `
    <div class="report-rupee">Total: ${fmt(total)}</div>
    <div class="report-header">Report Generated: ${new Date().toLocaleString()}</div>
    <div style="margin-top:12px;">
      <div class="row-item"><div>₹500 x ${d500}</div><div>${fmt(d500*500)}</div></div>
      <div class="row-item"><div>₹200 x ${d200}</div><div>${fmt(d200*200)}</div></div>
      <div class="row-item"><div>₹100 x ${d100}</div><div>${fmt(d100*100)}</div></div>
      <div class="row-item"><div>₹50 x ${d50}</div><div>${fmt(d50*50)}</div></div>
      <div class="row-item"><div>₹20 x ${d20}</div><div>${fmt(d20*20)}</div></div>
      <div class="row-item"><div>₹10 x ${d10}</div><div>${fmt(d10*10)}</div></div>
      <div class="row-item"><div>₹5 x ${d5}</div><div>${fmt(d5*5)}</div></div>
    </div>
    <div class="disclaimer">*** This calculator is for illustrative purposes only</div>
  `;
  document.getElementById('denominationResult').innerHTML = html;
}

/* ---------- Preclosure ---------- */
function showPreclosureManual(){
  const emiWithInt = Number(document.getElementById('emiWithInterest').value||0);
  const emiWithoutInt = Number(document.getElementById('emiWithoutInterest').value||0);
  const futureWith = Number(document.getElementById('futureEmiWithInterest').value||0);
  const futureWithout = Number(document.getElementById('futureEmiWithoutInterest').value||0);
  const currentOutstanding = Number(document.getElementById('currentOutstanding').value||0);

  const total = (emiWithInt * futureWith) + (emiWithoutInt * futureWithout) + currentOutstanding;

  const html = `
    <div class="report-header">Report Generated: ${new Date().toLocaleString()}</div>
    <div style="margin-top:8px;">
      <div class="row-item"><div>EMI With Interest × Future EMI With Interest</div><div>${fmt2(emiWithInt * futureWith)}</div></div>
      <div class="row-item"><div>EMI Without Interest × Future EMI Without Interest</div><div>${fmt2(emiWithoutInt * futureWithout)}</div></div>
      <div class="row-item"><div>Current Outstanding</div><div>${fmt2(currentOutstanding)}</div></div>
      <div class="row-item" style="font-weight:800;color:var(--primary);"><div>Total Pre-closure Amount</div><div>${fmt2(total)}</div></div>
    </div>
    <div class="disclaimer">*** Use actual bank statement for precise figures</div>
  `;
  document.getElementById('preclosureResult').innerHTML = html;
}

/* ---------- EMI Calculator ---------- */
function calcScheme(neft, rate, fees, dealer, type, term){
  const monthlyRate = rate/12/100;
  let advance = (term===12)?1:2;
  let S = neft + fees + dealer;
  let EMI = 0;
  for(let i=0;i<50;i++){
    if(type==="Flat"){
      EMI = (S + S*(rate/100)*(term/12))/term;
    } else {
      const r = monthlyRate;
      EMI = (S*r*Math.pow(1+r,term))/(Math.pow(1+r,term)-1);
    }
    const advAmt = advance*EMI;
    const newS = neft + fees + dealer + advAmt;
    if(Math.abs(newS - S) < 0.01){ S=newS; break; }
    S = newS;
  }
  EMI = Math.ceil(EMI);
  let totalPay = Math.ceil(EMI*term);
  let extra = Math.ceil(EMI*(term-advance)-neft);
  let loanAmount = Math.ceil(S);
  return {term, sanctioned:loanAmount, emi:EMI, advance, payableEmis:term-advance, totalPay, extra};
}

function generateEMIReport(){
  const neft=Number(document.getElementById("neft").value||0);
  const rate=Number(document.getElementById("rate").value||0);
  const fees=Number(document.getElementById("fees").value||0);
  const dealer=Number(document.getElementById("dealer").value||0);
  const type=document.getElementById("type").value;
  const terms=document.getElementById("terms").value.split(",").map(x=>Number(x.trim())).filter(x=>x>0);

  let html = `<div class="report-header">Report Generated On: ${new Date().toLocaleString()}</div>`;
  html += `<div class="disclaimer">*** This EMI Calculator is For Illustrative Purpose Only</div>`;
  html += '<div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px;">';

  terms.forEach(t=>{
    const r = calcScheme(neft,rate,fees,dealer,type,t);
    html += `<div class="card">
      <div class="row-item"><div>LOAN AMOUNT</div><div>${fmt(r.sanctioned)}</div></div>

      <div class="row-item highlight-big-blue"><div>NEFT / CHQ AMOUNT</div><div>${fmt(neft)}</div></div>

      <div class="row-item"><div>RATE OF INTEREST (%)</div><div>${rate.toFixed(2)}</div></div>
      <div class="row-item"><div>TERM (months)</div><div>${r.term}</div></div>
      <div class="row-item"><div>ADVANCE EMI</div><div>${r.advance}</div></div>

      <div class="row-item highlight-big-blue"><div>MONTHLY EMI</div><div>${fmt(r.emi)}</div></div>

      <div class="row-item highlight-big-blue"><div>PAYABLE EMI</div><div>${r.payableEmis}</div></div>

      <div class="row-item"><div>TOTAL PAYABLE</div><div>${fmt(r.totalPay)}</div></div>
      <div class="row-item" style="color:#b91c1c;font-weight:700;"><div>EXTRA TO BE PAID</div><div>${fmt(r.extra)}</div></div>
    </div>`;
  });

  html += '</div>';
  document.getElementById("report").innerHTML = html;
}

/* ---------- Vehicle EMI ---------- */
document.getElementById("generateVehicleEMI").addEventListener("click",()=>{
  const V = Number(document.getElementById("vprice").value||0);
  const D = Number(document.getElementById("vdown").value||0);
  const DI = Number(document.getElementById("vdealer").value||0);
  const PF = Number(document.getElementById("vproc").value||0);
  const ROI = Number(document.getElementById("vroi").value||0);
  const terms = document.getElementById("vterm").value.split(",").map(x=>Number(x.trim())).filter(x=>x>0);
  const now = new Date();
  let dt = now.toLocaleString();

  let html = "";
  terms.forEach(T=>{
    const adv = (T<=12)?1:2;
    const factorA = (1 + (ROI/100)*(T/12))/T;
    const baseS = V - D + DI + PF;
    const denom = 1 - adv*factorA;
    let sanctioned = (denom>0)? Math.ceil(baseS/denom) : NaN;
    const emi = Math.ceil(sanctioned*factorA);
    const advAmount = adv*emi;
    const dealerPayment = V - D + PF;
    const totalPayment = emi*(T-adv);
    const noOfPayableEMI = T-adv;
    const totalExtraPayment = totalPayment + D - V;

    html += `<div class="card">
      <div style="font-size:13px;color:var(--muted);margin-bottom:6px;">${dt}</div>
      <div class="row-item"><div>Vehicle Price</div><div>${fmt2(V)}</div></div>
      <div class="row-item"><div>Down Payment</div><div>${fmt2(D)}</div></div>

      <div class="row-item highlight-big-blue"><div>Dealer Payment</div><div>${fmt2(dealerPayment)}</div></div>

      <div class="row-item"><div>Sanctioned Loan Amount</div><div>${fmt2(sanctioned)}</div></div>
      <div class="row-item"><div>Loan Term (months)</div><div>${T}</div></div>
      <div class="row-item"><div>ROI (%)</div><div>${fmt2(ROI)}</div></div>

      <div class="row-item highlight-big-blue"><div>Calculated EMI</div><div>${fmt2(emi)}</div></div>

      <div class="row-item highlight-big-blue"><div>No Of Payable EMI</div><div>${noOfPayableEMI}</div></div>

      <div class="row-item"><div>Advance EMIs</div><div>${adv} (₹ ${fmt2(advAmount)})</div></div>
      <div class="row-item"><div>Processing Fees</div><div>${fmt2(PF)}</div></div>
      <div class="row-item"><div>Total Payment</div><div>${fmt2(totalPayment)}</div></div>
      <div class="row-item" style="color:#b91c1c;font-weight:700;"><div>Total Extra Payment</div><div>${fmt2(totalExtraPayment)}</div></div>
      <div class="disclaimer">*** This EMI Calculator is For Illustrative Purpose Only</div>
    </div>`;
  });

  document.getElementById("vehicleReport").innerHTML = html;
});

/* export & download functions */
function exportSectionPDF(elementId, filename){
  const { jsPDF } = window.jspdf;
  const el = document.getElementById(elementId);
  if(!el){ alert("Nothing to export"); return; }
  html2canvas(el, {scale:2, useCORS:true}).then(canvas=>{
    const img = canvas.toDataURL("image/png");
    const doc = new jsPDF('p','pt','a4');
    const pdfW = doc.internal.pageSize.getWidth();
    const pdfH = (canvas.height * pdfW) / canvas.width;
    doc.addImage(img,'PNG',0,0,pdfW,pdfH);
    doc.save(filename);
  }).catch(err=>{ console.error(err); alert("Export failed"); });
}

function exportSectionJPG(elementId, filename){
  const el = document.getElementById(elementId);
  if(!el){ alert("Nothing to export"); return; }
  html2canvas(el, {scale:2, useCORS:true}).then(canvas=>{
    const link = document.createElement('a');
    link.download = filename;
    link.href = canvas.toDataURL('image/jpeg',1.0);
    link.click();
  }).catch(err=>{ console.error(err); alert("Export failed"); });
}

/* Preclosure Excel (simple table) */
function exportPreclosureExcel(){
  // create a small table from the preclosure result fields if present
  const emiWithInt = Number(document.getElementById('emiWithInterest').value||0);
  const emiWithoutInt = Number(document.getElementById('emiWithoutInterest').value||0);
  const futureWith = Number(document.getElementById('futureEmiWithInterest').value||0);
  const futureWithout = Number(document.getElementById('futureEmiWithoutInterest').value||0);
  const currentOutstanding = Number(document.getElementById('currentOutstanding').value||0);
  const total = (emiWithInt * futureWith) + (emiWithoutInt * futureWithout) + currentOutstanding;

  const arr = [
    ["Description","Value"],
    ["EMI With Interest", emiWithInt],
    ["EMI Without Interest", emiWithoutInt],
    ["Future EMI With Interest", futureWith],
    ["Future EMI Without Interest", futureWithout],
    ["Current Outstanding", currentOutstanding],
    ["Total Preclosure Amount", total]
  ];
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(arr);
  XLSX.utils.book_append_sheet(wb, ws, "Preclosure");
  XLSX.writeFile(wb, "Preclosure_Report.xlsx");
}

/* ---------- Chit Fund ---------- */
function generateSchedule() {
  const members = parseInt(document.getElementById('members').value||0);
  const term = parseInt(document.getElementById('term').value||0);
  const S = parseFloat(document.getElementById('subscription').value||0);
  const P = parseInt(document.getElementById('payable').value||0);
  let deductions = document.getElementById('deductions').value.split(",").map(x => Number(x.trim()));

  if(deductions.length !== term){
    alert("Deduction % length must equal Term months!");
    return;
  }

  let html = `<table><thead><tr><th>Month</th><th>Total Paid So Far</th><th>Future Collection</th><th>Deduction %</th><th>Deduction (per member)</th><th>Month Payout</th></tr></thead><tbody>`;
  let totalBalance = 0;
  let totalDeductionPerMember = 0;

  for(let m=1; m<=term; m++){
    let paidSoFar = S * m;
    let futureCollection = (S * term) - paidSoFar;
    let deductionPerMember = (deductions[m-1]/100) * futureCollection;
    let monthPayout = (P * S) - deductionPerMember;

    html += `<tr>
      <td>${m}</td>
      <td>${paidSoFar.toFixed(2)}</td>
      <td>${futureCollection.toFixed(2)}</td>
      <td>${deductions[m-1]}%</td>
      <td>${deductionPerMember.toFixed(2)}</td>
      <td>${monthPayout.toFixed(2)}</td>
    </tr>`;

    totalBalance += monthPayout;
    totalDeductionPerMember += deductionPerMember;
  }

  html += `<tr><th colspan="4">Total Deduction (per member)</th><th>${totalDeductionPerMember.toFixed(2)}</th><th></th></tr>`;
  html += `<tr><th colspan="5">Total Payout</th><th>${totalBalance.toFixed(2)}</th></tr>`;
  html += `</tbody></table>`;

  document.getElementById('schedule').innerHTML = html;
  document.getElementById('dealResult').innerHTML = totalBalance>=0 ? "<div class='card' style='text-align:center;color:green;font-weight:800;'>GOOD DEAL ✅</div>" : "<div class='card' style='text-align:center;color:#b91c1c;font-weight:800;'>WRONG DEAL ❌</div>";
}

/* Export Chit Excel */
function exportChitExcel() {
  const table = document.querySelector('#schedule table');
  if(!table){ alert('Generate schedule first'); return; }
  const wb = XLSX.utils.table_to_book(table, {sheet:"ChitFund"});
  XLSX.writeFile(wb, 'ChitFund.xlsx');
}

/* ---------- Vehicle export buttons ---------- */
document.getElementById("downloadVehiclePdf").addEventListener("click",()=>{
  exportSectionPDF('vehicleReport','VehicleEMI_Report.pdf');
});
document.getElementById("downloadVehicleImg").addEventListener("click",()=>{
  exportSectionJPG('vehicleReport','VehicleEMI_Report.jpg');
});

/* ---------- Sharing helpers (WhatsApp / Email / SMS) ---------- */
/* The browser can only open links (prefill text). Attaching files requires server/API. */
function getPlainTextFromElement(el){
  if(!el) return '';
  // Clone to avoid modifying DOM
  const clone = el.cloneNode(true);
  // Remove buttons from clone
  clone.querySelectorAll('button, a, input, select').forEach(n => n.remove());
  // Convert table to CSV-ish for readability
  const tables = clone.querySelectorAll('table');
  tables.forEach(tbl=>{
    let txt = '';
    for(const r of tbl.rows){
      const cells = Array.from(r.cells).map(c=>c.innerText.trim().replace(/\s+/g,' '));
      txt += cells.join(' | ') + "\n";
    }
    const pre = document.createElement('pre');
    pre.innerText = txt;
    tbl.parentNode.replaceChild(pre, tbl);
  });
  return clone.innerText.trim();
}

function shareReportByText(elementId, title){
  const el = document.getElementById(elementId);
  let text = title + " — " + new Date().toLocaleString() + "\n\n";
  text += getPlainTextFromElement(el) || "Report generated. Please open app to view exports.";
  const encoded = encodeURIComponent(text);
  // Use wa.me to open WhatsApp Web / mobile with prefilled text
  window.open("https://wa.me/?text=" + encoded, "_blank");
}

function shareReportByEmail(elementId, title){
  const el = document.getElementById(elementId);
  let body = title + " — " + new Date().toLocaleString() + "\n\n";
  body += getPlainTextFromElement(el) || "Report generated. Please open attachment if available.";
  const subject = encodeURIComponent(title);
  const encodedBody = encodeURIComponent(body);
  window.location.href = `mailto:?subject=${subject}&body=${encodedBody}`;
}

function shareReportBySMS(elementId, title){
  const el = document.getElementById(elementId);
  let body = title + " — " + new Date().toLocaleString() + "\n\n";
  body += getPlainTextFromElement(el) || "Report generated.";
  const encoded = encodeURIComponent(body);
  // sms: scheme behavior varies across platforms (mobile vs desktop)
  window.location.href = `sms:?&body=${encoded}`;
}

/* Optional helper: single-function to export section (PDF/JPG) */
function exportSectionPDF_autoName(elementId){
  exportSectionPDF(elementId, (elementId||'Report') + ".pdf");
}

/* ---------- Initialization: set minimal defaults ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  document.getElementById('denominationResult').innerHTML = "<div class='report-header'>Enter denominations and click Calculate</div>";
  document.getElementById('preclosureResult').innerHTML = "<div class='report-header'>Fill details and click Show Summary</div>";
  document.getElementById('report').innerHTML = "<div class='report-header'>Set values and click Generate Report</div>";
  document.getElementById('vehicleReport').innerHTML = "<div class='report-header'>Click Generate Report(s) to display vehicle EMIs</div>";
  document.getElementById('schedule').innerHTML = "<div class='report-header'>Click Generate Schedule</div>";
});
</script>
</body>
</html>
